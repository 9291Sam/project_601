\chapter{Modeling}
Although a ballbot is a fairly complex system, it can be thought of in various 
ways. The most useful of which, will be as a inverted pendulum affixed atop a 
cart. It's states can be seen from inspection of its movement, while state
equations can be derived by using lagrangian mechanics to derive a continuous
nonlinear time-invariant system.

Upon inspection we can note the following states, additionally shown in \ref{fig:unicycle_states}.
\begin{itemize}
   \vspace{-0.3cm}\item $x$ positional states: $x$ and $\dot{x}$
   \vspace{-0.3cm}\item $y$ positional states: $y$ and $\dot{y}$
   \vspace{-0.3cm}\item Pitch states: $\theta$ and $\dot{\theta}$
   \vspace{-0.3cm}\item Roll states: $\phi$ and $\dot{\phi}$
\end{itemize}

Additionally, we define the following constants that parametrize the simulation.
\begin{itemize}
   \vspace{-0.3cm}\item Radius of the ball: $r$
   \vspace{-0.3cm}\item Distance between center of mass of the ball ball and the center of mass of the body: $d$
   \vspace{-0.3cm}\item Mass of the ball: $m_{ball}$
   \vspace{-0.3cm}\item Mass of the body: $m_{body}$
   \vspace{-0.3cm}\item Moment of the ball around all axes: $I_{ball}$
   \vspace{-0.3cm}\item Moment of the body around the x and y axes: $I_{bodyxy}$
   \vspace{-0.3cm}\item Moment of the body around the z axis: $I_{bodyz}$
   \vspace{-0.3cm}\item Force of gravity: $g$
\end{itemize}

Finally, we define the following inputs to the system.
\begin{itemize}
   \vspace{-0.3cm}\item Ball x Torque: $\tau_x$
   \vspace{-0.3cm}\item Ball y Torque: $\tau_y$
\end{itemize}

Note, that in order to simplify the modeling, we use perpendicular torques
acting on the ball, in practical application, three linearly dependent torques
are actually used. These are equivalent however their relation is not explicitly
defined by this document.

\section{Definition of States}
\begin{figure}[h!]
  \centering
  \includegraphics[width=0.403125\linewidth]{with states.png}
  \caption{Drawing of a Unicycle with states}
  \label{fig:unicycle_states}
\end{figure}

These states, are grouped into a set of generalized coordinates,
$q = [x, y, \theta, \phi]\top$ and then combined to form the full state of the
system.

$$ \state = 
  \bmat{q \\ \dot{q}} =
  \begin{bmatrix}
    x            \\
    y            \\
    \theta       \\
    \phi         \\
    \dot{x}      \\
    \dot{y}      \\
    \dot{\theta} \\
    \dot{\phi}   \\
  \end{bmatrix}
$$

The inputs are represented as a vector $u = \bmat{\tau_x \\ \tau_y}$

\section{Derivation of State Derivatives}

A general nonlinear time-invariant system is defined as
$\dot{\state} = f(\state, u)$, however for the purposes of this document, it is
more helpful to think in the form
$$\dot{\state} = \bmat{\dot{q} \\ \ddot{q}} = f(q, \dot{q})$$

Upon inspection, one can see that both sides of the equation share the state 
$\dot{q}$, showing that one just needs to find a function
$\ddot{q} = f(q, \dot{q}, u)$ which models the dynamics of the system.

The derivation of thus function will be achieved through the use of lagrangian
mechanics. Lagrangian mechanics constructs a function, called the lagrangian
defined as the difference between the kinetic energies $T$ and potential 
energies $U$ of a system:
$$ \mathcal{L} = T - U$$

For the ballbot system, the total kinetic energy is the sum of the translational
and rotational energy of both the ball and the body. Meanwhile, the total
potential energy is defined as the sum of the gravitational potential energy of 
the ball and the body. 

By combining this, we can state the full lagrangian as:
$\mathcal{L} = 
  (E_{ball, translation} + E_{ball, angular} + E_{body, translation} + E_{body, angular})-
  (E_{ball, height} + E_{body, height})
$

\subsection{Derivation of translational energies} \label{der_translation}

The translational kinetic energy of any rigid body is defined by the velocity
of its center of mass. While the scalar form $E = \frac{1}{2} m * v^2$ is 
familiar, in the context of this document, it will need to be extended into the
vector case. This more general equation is written:
$$E = \frac{1}{2} m *  v^\top * v$$

In our case, defining these velocities is tricky, so we rely on the fact that
the time derivative of the position vector is the velocity vector. This final
equation is written:
$$E = \frac{1}{2} m *  \dot{p}^\top * \dot{p}$$

where $p$ is the position vector in the frame of the object. This general
formulation allows us to derive the translational energy of an object from it's
position vector.

\paragraph{Translational energy of the ball}

Starting off with the position of the ball, it can be easily seen that the
position of the center of mass of the ball will be the sum of the position of
it's base plus the radius of the ball upwards. 
$$p_{ball} = \bmat{x \\ y \\ 0} + \bmat{x \\ y \\ r} = \bmat{x \\ y \\ r}$$

Taking the time derivative of this vector yields 
$$v_{ball} = \dot{p}_{ball} = \bmat{\dot{x} \\ \dot{y} \\ 0}$$

Finally, this can be inputted into the translational energy formula to arrive at
$$E_{ball, translation} = \frac{1}{2} m_ball * v_{ball}^\top * v_{ball}$$

\paragraph{Translational energy of the body}

The position of the body's center of mass is more complex as it depends not only
on the position of the ball, but also on the angles of the body ($\theta$ and
$\phi$) and the distance between the ball's center of mass and the body's center
of mass ($d$)

However, the rotation of the body is defined by the rotation matrix sequence
of rotating around the X axis an angle $\phi$ followed by a rotation around
the Y axis an angle $\theta$. These orations can be codified in the rotation 
matrices:
$$
R_{body} = R_y(\theta) R_x(\phi) = 
\bmat{
\cos\theta & 0 & \sin\theta \\ 
0 & 1 & 0 \\ 
-\sin\theta & 0 & \cos\theta 
}
\bmat{ 
1 & 0 & 0 \\ 
0 & \cos\phi & -\sin\phi \\ 
0 & \sin\phi & \cos\phi 
}
$$

By using these matrices, one can easily calculate the position of the center
of mass of the body as
$$p_{body} = p_{ball} + R_{body} \bmat{ 0 \\ 0 \\ d }$$

Therefore, using the same method as established previously, one can calculate
the velocity as the time derivative of the position vector. Do note that, 
because of the chain rule, and the resulting expression being dependent on 
$\theta$ and $\phi$ that the jacobian should be used in the form
$$v_{body} = \frac{d p_{body}}{dt} = \frac{\partial p_{body}}{\partial q} \frac{\partial q}{\partial t}$$

Resulting in a similar relation of
$$E_{body, translation} = \frac{1}{2} m_body *  v_{body}^\top * v_{body}$$

\subsection{Derivation of angular energies}

In a similar method as in \ref{der_translation}, one can start with the equation
for the angular energy and similarly extend it to multiple. The scalar form is
$E = \frac{1}{2} I \omega^2$ where $I$ is the moment of inertia of the spinning
body and $\omega$ is the angular velocity of that body. In the vector case,
this similarly transforms into 
$$E = \frac{1}{2} \omega^\top * I * \omega$$. 

\paragraph{Rotational energy of the ball}

Since the ball never slips on the ground, it's angular velocity is directly
derived from the linear velocity of the ball. For a ball of radius $r$, motion
in the +X axis, induces a rotation around the +y axis. And, similarly, 
motion in the +y axis induces a rotation round the -x axis because of the right
handed axes being used. Therefore,

$$\omega_{ball} = \bmat{-\dot{y}/r \\ \dot{x}/r \\ 0}$$

which results in the final energy equation
$$E_{ball, angular} = \frac{1}{2} \omega_{ball}^\top * I_ball * \omega_{ball}$$. 


\paragraph{Rotational energy of the body}

The body's angular velocity, $\omega_{body}$ is similarly calculated from the 
time derivatives of the body angles. Do note that the angles must end up in the
local frame of the body with respect to the global axes. The easiest way to do
this is to bring all angles into the global coordinate frame, before 
transforming them back into the local space of the body. Doing so, yields the 
equation

$$\omega_{body} = R_{body}^\top (\bmat{0 \\ \dot{theta} \\ 0} + R_y(\theta)\bmat{\dot{\phi} \\ 0 \\ 0})$$

and the energy relation
$$E_{body, angular} = \frac{1}{2} \omega_{body}^\top * I_body * \omega_{body}$$. 

\subsection{Derivation of potential energies}

The potential energies of the ball and the body can be calculated from the 
formula for gravitational potential energy of a point mass of mass $m$ at a 
height $h$ with gravitational acceleration $g$  $E = m*g*h$.

Since we already calculated the position vectors of the ball and the body, 
we can just access their $z$ component and use that in the formula.
Mathematically, this can be stated by taking the dot product with the third
cartesian basis vector $\hat{k}$.

Therefore the potential energy for both the ball and body can be expressed as
$$E_{ball, height} = m_ball * g * (p_{ball} \cdot \hat{k})$$
$$E_{body, height} = m_body * g * (p_{body} \cdot \hat{k})$$

\section{Formation of the equations of motion}

Using the relation derived above for the lagrangian, we now have the 
lagrangian and can use it to derive our equations of motion. The equations of 
motion are derived using the Euler-Lagrange equation, which for this document
will be written as
$$\frac{d}{dt} \frac{\partial \mathcal{L}}{\partial \dot{q}} -
\frac{\partial \mathcal{L}}{\partial q} = \mathcal{Q}$$

where $\mathcal{Q}$ are the generalized input forces of the system. However, in
this case, our input forces are $\tau_x$ and $\tau_y$ which require a
transformation into our generalized coordinates $q$

\paragraph{Generalized Forces}
The ballbot's inputs are modeled as two torques $\tau_x$ and $\tau_y$ which each
affect both the rotation of the body angles and the position of the ball.
The matrix that maps between this is 
$$\mathcal{Q} = B_{generalized}*u = \bmat{0&-1/r \\ -1/r&0 \\ 0&1 \\ 1&0} \bmat{\tau_x \\ \tau_y}$$

\paragraph{Equations of motion}
This symbolic representation of the equations of motion can be symbolically solved to return
a function $\ddot{q} = f(q, \dot{q})$. 

Finally, the state update equation we sought $\dot{\state}$ can be calculated
$$\dot{\state} = \bmat{\dot{q} \\ f(q, \dot{q})}$$